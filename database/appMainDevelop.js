Ext.require("Ext.form.*,Ext.layout.container.Column,Ext.direct.*,Ext.data.*,Ex.grid.*,Ext.util.*,Ext.view.View".split(","));
Ext.onReady(function(){function d(){v=C=o=D=!1;E=y=!0;I=O=P=Q=!1;Z=!0;Ext.getCmp("gridFormForm").getForm().reset();Ext.getCmp("formAbstract").getForm().reset();Ext.getCmp("formLocation").getForm().reset();Ext.getCmp("buttonForm").setText("Save new record");Ext.getCmp("buttonForm").disable();Ext.getCmp("buttonFormMap").disable();Ext.getCmp("buttonDelete").disable();Ext.getCmp("buttonFormPositionMap").disable();Ext.getCmp("grid").getSelectionModel().deselectAll(!0);Ext.getCmp("gridLevel").getStore().removeAll();
Ext.getCmp("gridBbox").getStore().removeAll();Ext.getCmp("buttonFormAbstract").btnInnerEl&&Ext.getCmp("buttonFormAbstract").btnInnerEl.setStyle({color:"black"});Ext.getCmp("buttonForm").btnInnerEl.setStyle({color:"black"});Ext.getCmp("buttonAddLevel").btnInnerEl&&Ext.getCmp("buttonAddLevel").btnInnerEl.setStyle({color:"black"});Ext.getCmp("buttonFormPosition").btnInnerEl&&(Ext.getCmp("buttonFormPosition").btnInnerEl.setStyle({color:"black"}),Ext.getCmp("buttonFormPositionMap").btnInnerEl.setStyle({color:"black"}))}
function g(a){Ext.Msg.show({title:"Delete record",msg:"You are deleting a record permanently, this cannot be undone. Proceed?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(b){"yes"===b&&(""!=a.getSelection()[0].data.id&&(t.proxy.api.destroy(a.getSelection()[0].data),t.remove(a.getSelection())),d())}})}function J(){Ext.getCmp("BRYField").removeListener("change",w);Ext.getCmp("TLYField").removeListener("change",w);Ext.getCmp("TLXField").removeListener("change",w);Ext.getCmp("BRXField").removeListener("change",
w)}function u(){Ext.getCmp("BRYField").addListener("change",w);Ext.getCmp("TLYField").addListener("change",w);Ext.getCmp("TLXField").addListener("change",w);Ext.getCmp("BRXField").addListener("change",w)}function R(a,b,c,h,n,d){if(f.hasFeature){f.unsetFeature();var K=q.features[0].clone();q.destroyFeatures();K.geometry.getVertices()[a].transform(k,l).move(c,h);K.geometry.getVertices()[b].transform(k,l).move(n,d);K.geometry.getVertices()[a].transform(l,k);K.geometry.getVertices()[b].transform(l,k);
q.addFeatures(K);f.setFeature(K,{rotation:0,scale:1,ratio:1});f.hasFeature=!0}else z=parseFloat(Ext.getCmp("BRYField").getValue()),F=parseFloat(Ext.getCmp("TLYField").getValue()),A=parseFloat(Ext.getCmp("TLXField").getValue()),G=parseFloat(Ext.getCmp("BRXField").getValue()),a=[],a[0]=(new OpenLayers.Geometry.Point(A,z)).transform(l,k),a[1]=(new OpenLayers.Geometry.Point(A,F)).transform(l,k),a[2]=(new OpenLayers.Geometry.Point(G,F)).transform(l,k),a[3]=(new OpenLayers.Geometry.Point(G,z)).transform(l,
k),a[4]=(new OpenLayers.Geometry.Point(A,z)).transform(l,k),a=new OpenLayers.Geometry.LinearRing(a),b=[],b[0]=a,a=new OpenLayers.Geometry.Polygon(b),a=new OpenLayers.Feature.Vector(a),q.addFeatures(a),f.setFeature(a,{rotation:0,scale:1,ratio:1}),f.hasFeature=!0,Ext.getCmp("buttonLocationUpdate").enable()}function qa(){B=Ext.create("widget.window",{id:"imageWindow",itemId:"imageWindow",closable:!0,closeAction:"hide",draggable:!1,modal:!0,hideMode:"offsets",width:820,height:560,resizable:!1,layout:"auto",
bodyStyle:"padding: 5px;",listeners:{afterrender:function(){},show:function(){r()},hide:function(){}},items:[panelImageView]})}function r(){ra.load({id:e,params:{table:S},callback:function(a,b){if(b.response){var c=Ext.JSON.decode(b.response.responseText).warning;""!=c&&Ext.Msg.show({title:"Some images missing",msg:c,buttons:Ext.Msg.YES,icon:Ext.Msg.WARNING})}}});Ext.getCmp("panelImageViewRightBottom").update("")}function sa(a){Ext.getCmp("formAbstract").getForm().load({params:{id:a},success:ta,failure:ta})}
function $(a){Ext.data.StoreManager.lookup("storeBbox").load({params:{id:a},success:ua,failure:ua})}function aa(){Ext.data.StoreManager.lookup("storeLevel").load({id:e,callback:function(a,b,c){c?(Ext.getCmp("buttonAddLevel").enable(),Ext.getCmp("buttonRefreshLevel").enable(),Ext.getCmp("comboboxLevel2").setVisible(!1),Ext.getCmp("comboboxLevel3").setVisible(!1)):(Ext.getCmp("buttonAddLevel").disable(),Ext.getCmp("buttonDeleteLevel").disable(),Ext.getCmp("buttonRefreshLevel").disable())}})}function va(){x=
"";D&&(x+="Abstract pending<br/>");o&&(x+="Bounding box pending<br/>");C&&(x+="Article pending<br/>");v&&(x+="Levels pending<br/>");return x}function ha(a,b){if(b){var c=a.getPicker().store.data.items;if(0<c.length)for(var h in c)if(a.getRawValue()===c[h].data.NAME)return console.log(a.id+" has "+c[h].data.NAME),!0;a.setValue("");return!1}return!0}function Ma(a){l=new OpenLayers.Projection("EPSG:4326");k=new OpenLayers.Projection("EPSG:900913");var b=new OpenLayers.Bounds(-20037508,-20037508,20037508,
20037508),c=b.clone(),b={projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",numZoomLevels:18,maxResolution:156543.0339,maxExtent:b,restrictedExtent:c};mappa=m=new OpenLayers.Map(a,b);var h=OpenLayers.Layer.Vector.prototype.renderers,a=new OpenLayers.Layer.OSM("Open Street Map"),b=new OpenLayers.Layer.Bing({key:ia,type:"Road",name:"Road"}),c=new OpenLayers.Layer.Bing({key:ia,type:"Aerial",name:"Aerial"}),n=new OpenLayers.Layer.Bing({key:ia,
type:"AerialWithLabels",name:"Aerial With Labels"});pol=q=new OpenLayers.Layer.Vector("box",{styleMap:new OpenLayers.StyleMap({transform:new OpenLayers.Style({display:"${getDisplay}",cursor:"${role}",pointRadius:5,fillColor:"white",fillOpacity:1,strokeColor:"black"},{context:{getDisplay:function(b){return"se-resize"===b.attributes.role?"none":""}}}),rotate:new OpenLayers.Style({display:"${getDisplay}",pointRadius:10,fillColor:"#ddd",fillOpacity:1,strokeColor:"black"},{context:{getDisplay:function(b){return"se-rotate"===
b.attributes.role?"":"none"}}})}),renderers:h,displayInLayerSwitcher:!1});L=new OpenLayers.Layer.Vector("boundindlayer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillColor:"#ff0000",fillOpacity:0.2,strokeColor:"#000000",strokeWidth:0.4})})});var h=new OpenLayers.Style({cursor:"pointer",fillColor:"#0000ff",fillOpacity:0.5,pointRadius:7,strokeColor:"#ff0000",strokeWidth:0.5,graphicName:"circle"}),d=new OpenLayers.Style({cursor:"pointer",fillColor:"#ff0000",fillOpacity:1,pointRadius:5,
strokeColor:"#000000",strokeWidth:0.4,graphicName:"x"}),h=new OpenLayers.StyleMap({"default":h,select:d});H=new OpenLayers.Layer.Vector("places",{displayInLayerSwitcher:!1});H.styleMap=h;h=new OpenLayers.Style({strokeColor:"yellow",strokeOpacity:1,strokeWidth:1,fillOpacity:0,pointRadius:6,pointerEvents:"visiblePainted"},{rules:[new OpenLayers.Rule({minScaleDenominator:25E5,symbolizer:{}}),new OpenLayers.Rule({maxScaleDenominator:25E5,symbolizer:{label:"${NAME}",fontColor:"white",fontSize:"10px",fontFamily:"Courier New, monospace",
fontWeight:"bold",labelOutlineColor:"black",labelOutlineWidth:5}})]});ba=new OpenLayers.Layer.Vector("nca",{styleMap:new OpenLayers.StyleMap({"default":h})});m.addLayers([a,b,c,n,ba,L,q,H]);m.addControl(new OpenLayers.Control.MousePosition);polyOptions={sides:4,irregular:!0};T=new OpenLayers.Control.DrawFeature(q,OpenLayers.Handler.RegularPolygon,{handlerOptions:polyOptions,callbacks:{create:function(){f&&(f.unsetFeature(),f.hasFeature=!1);J();q.destroyFeatures()}},featureAdded:function(b){f.setFeature(b,
{rotation:0,scale:1,ratio:1});f.hasFeature=!0;var a=b.geometry.bounds.transform(k,l);Ext.getCmp("BRYField").setValue(a.bottom);Ext.getCmp("TLYField").setValue(a.top);Ext.getCmp("TLXField").setValue(a.left);Ext.getCmp("BRXField").setValue(a.right);Ext.getCmp("buttonLocationPan").toggle();z=parseFloat(a.bottom);F=parseFloat(a.top);A=parseFloat(a.left);G=parseFloat(a.right);b.geometry.bounds.transform(l,k);u();Ext.getCmp("buttonLocationUpdate").enable()}});m.addControl(T);polControl=T;transf=f=new OpenLayers.Control.TransformFeature(q,
{renderIntent:"transform",rotationHandleSymbolizer:"rotate",rotate:!1,eventListeners:{transform:function(a){J();a=a.object.feature.geometry.bounds.transform(k,l);Ext.getCmp("BRYField").setValue(a.bottom);Ext.getCmp("TLYField").setValue(a.top);Ext.getCmp("TLXField").setValue(a.left);Ext.getCmp("BRXField").setValue(a.right)},transformcomplete:function(a){Ext.getCmp("BRYField").setValue(a.feature.geometry.bounds.bottom);Ext.getCmp("TLYField").setValue(a.feature.geometry.bounds.top);Ext.getCmp("TLXField").setValue(a.feature.geometry.bounds.left);
Ext.getCmp("BRXField").setValue(a.feature.geometry.bounds.right);z=parseFloat(a.feature.geometry.bounds.bottom);F=parseFloat(a.feature.geometry.bounds.top);A=parseFloat(a.feature.geometry.bounds.left);G=parseFloat(a.feature.geometry.bounds.right);a.feature.geometry.bounds.transform(l,k);u()}}});f.hasFeature=!1;m.addControl(f);selezioneControl=U=new OpenLayers.Control.SelectFeature(H,{onSelect:function(a){selectedFeature=a;popup=new OpenLayers.Popup.FramedCloud("info",a.geometry.getBounds().getCenterLonLat(),
null,"<div style='font-size:.8em'>Feature: "+a.attributes.NAME+"<br>id: "+a.attributes.id+"</div>",null,!0,function(){U.unselect(selectedFeature)});a.popup=popup;m.addPopup(popup);M=a;Ext.getCmp("buttonPlaceUpdate").isVisible()&&Ext.getCmp("buttonPlaceUpdate").enable();posto=M},onUnselect:function(a){Ext.getCmp("buttonPlaceUpdate").isVisible()&&Ext.getCmp("buttonPlaceUpdate").disable();m.removePopup(a.popup);a.popup.destroy();a.popup=null}});m.addControl(U);m.addControl(new OpenLayers.Control.LayerSwitcher);
m.setCenter((new OpenLayers.LonLat(-2,54)).transform(l,k),5)}function wa(a){return a=Ext.create("widget.window",{id:"locationwindow",itemId:"locationwindow",title:"Map window",closable:!0,closeAction:"hide",draggable:!1,modal:!0,hideMode:"offsets",width:1E3,height:750,resizable:!1,bodyStyle:"padding: 5px;",layout:{type:"vbox",align:"stretch"},listeners:{afterrender:function(){Ext.getCmp("fieldsetBoundingBox").setHeight(Ext.getCmp("formBoundingBox").getHeight()-10);xa="mapWindow-body";m||Ma(xa)},show:function(){if(Ext.getCmp("fieldsetBoundingBox").isDisabled()){var a=
Ext.getCmp("comboboxPlace").getPicker().store.data.items,c=[],h;for(h in a)c.push(a[h].data.NAME);c=uniqueArr(c);a=c.join();0<Ext.getCmp("gridBbox").store.count()&&(requestBboxes=Ext.Ajax.request({url:"getPlaces/bbox.php",method:"post",params:{id:e},success:function(a){a=Ext.JSON.decode(a.responseText);L.addFeatures(V.read(a))},failure:function(){}}));ya=Ext.Ajax.request({url:"getPlaces/dataFeeder.php",method:"post",params:{place:a},success:function(a){a=Ext.JSON.decode(a.responseText);H.addFeatures(V.read(a));
U.activate();m.zoomToExtent(H.getDataExtent())},failure:function(){}})}else ja=f.hasFeature=!1,J(),Ext.getCmp("BRYField").setValue(Ext.getCmp("BRY").getValue()),Ext.getCmp("TLYField").setValue(Ext.getCmp("TLY").getValue()),Ext.getCmp("TLXField").setValue(Ext.getCmp("TLX").getValue()),Ext.getCmp("BRXField").setValue(Ext.getCmp("BRX").getValue()),u(),Ext.getCmp("formBoundingBox").getForm().isValid()&&R(0,0,0,0,0,0),f.hasFeature&&m.zoomToExtent(q.getDataExtent()),za=Ext.Ajax.request({url:"getPlaces/dataFeeder.php",
method:"get",params:{singlePlace:Ext.getCmp("comboboxPlace").getValue()},success:function(a){a=Ext.JSON.decode(a.responseText);H.addFeatures(V.read(a))},failure:function(){}}),0==ba.features.length&&(requestNCAId=Ext.Ajax.request({url:"getPlaces/NCA.geojson",method:"get",params:{place:a},success:function(a){a=Ext.JSON.decode(a.responseText);ba.addFeatures(V.read(a))},failure:function(){}})),0<Ext.getCmp("gridBbox").store.count()&&(requestBboxes=Ext.Ajax.request({url:"getPlaces/bbox.php",method:"post",
params:{id:e},success:function(a){a=Ext.JSON.decode(a.responseText);L.addFeatures(V.read(a))},failure:function(){}}))},hide:function(){Ext.getCmp("fieldsetBoundingBox").isDisabled()?(Ext.Ajax.abort(ya),0<m.popups.length&&M&&(m.removePopup(M.popup),M.popup.destroy(),M.popup=null),L.removeAllFeatures(),Ext.getCmp("buttonPlaceUpdate").disable()):(f.hasFeature&&ja&&(Ext.getCmp("BRY").setValue(Ext.getCmp("BRYField").getValue()),Ext.getCmp("TLY").setValue(Ext.getCmp("TLYField").getValue()),Ext.getCmp("TLX").setValue(Ext.getCmp("TLXField").getValue()),
Ext.getCmp("BRX").setValue(Ext.getCmp("BRXField").getValue())),f.hasFeature&&(f.hasFeature=!1,f.unsetFeature(),q.destroyFeatures()),Ext.Ajax.abort(za),Ext.Ajax.abort(requestNCAId),L.removeAllFeatures());H.removeAllFeatures();U.deactivate()}},items:[{xtype:"form",frame:!0,id:"formBoundingBox",itemId:"formBoundingBox",flex:3,paramOrder:["id"],items:[{xtype:"fieldset",id:"fieldsetBoundingBox",itemId:"fieldsetBoundingBox",title:"Bounding box",defaults:{labelWidth:89,layout:{type:"hbox",defaultMargins:{top:0,
right:0,bottom:0,left:30}}},items:[{xtype:"fieldcontainer",id:"fieldContainerX",itemId:"fieldContainerX",combineErrors:!0,msgTarget:"under",defaults:{xtype:"textfield",width:240,labelWidth:130,enableKeyEvents:!0,listeners:{change:w}},items:[{name:"TLX",id:"TLXField",itemId:"TLXField",fieldLabel:"Top-left long (X)",vtype:"coordinateX",bottomRightX:"BRXField",allowBlank:!1},{name:"BRX",id:"BRXField",itemId:"BRXField",fieldLabel:"Bottom-right long (X)",vtype:"coordinateX",topLeftX:"TLXField",allowBlank:!1}]},
{xtype:"fieldcontainer",id:"fieldContainerY",itemId:"fieldContainerY",combineErrors:!0,msgTarget:"under",defaults:{xtype:"textfield",width:240,labelWidth:130,enableKeyEvents:!0,listeners:{change:w}},items:[{name:"TLY",id:"TLYField",itemId:"TLYField",fieldLabel:"Top-left lat (Y)",vtype:"coordinateY",bottomRightY:"BRYField",allowBlank:!1},{name:"BRY",id:"BRYField",itemId:"BRYField",fieldLabel:"Bottom-right lat (Y)",vtype:"coordinateY",topLeftY:"TLYField",allowBlank:!1}]}]}]},{id:"mapWindow",itemId:"mapWindow",
flex:10,buttons:[{itemId:"buttonLocationPan",id:"buttonLocationPan",scale:"large",width:32,height:40,iconCls:"panMap",text:"Pan",enableToggle:!0,pressed:!0,toggleGroup:"toggleGroup",toggleHandler:function(a,c){c?T.deactivate():Ext.getCmp("buttonLocationDraw").toggle(!0)}},{itemId:"buttonLocationDraw",id:"buttonLocationDraw",scale:"large",width:32,height:40,iconCls:"drawMap",text:"Draw",enableToggle:!0,toggleGroup:"toggleGroup",toggleHandler:function(a,c){c?T.activate():Ext.getCmp("buttonLocationPan").toggle(!0)}},
{itemId:"buttonLocationClear",id:"buttonLocationClear",scale:"large",width:32,height:40,iconCls:"clearMap",text:"Clear",handler:function(){f&&(f.unsetFeature(),f.hasFeature=!1);q.destroyFeatures();Ext.getCmp("buttonLocationUpdate").disable();Ext.getCmp("BRYField").setRawValue("");Ext.getCmp("TLYField").setRawValue("");Ext.getCmp("TLXField").setRawValue("");Ext.getCmp("BRXField").setRawValue("")}},{itemId:"buttonLocationUpdate",id:"buttonLocationUpdate",scale:"large",width:32,height:40,iconCls:"updateMap",
text:"Insert",disabled:!0,handler:function(){Ext.getCmp("formBoundingBox").getForm().isValid()&&(o=ja=!0,Ext.getCmp("buttonFormPosition").enable(),Ext.getCmp("buttonFormPosition").btnInnerEl.setStyle({color:"red"}),Ext.getCmp("locationwindow").hide())}},{itemId:"buttonPlaceUpdate",id:"buttonPlaceUpdate",scale:"large",width:32,height:40,iconCls:"updateMap",text:"Place",disabled:!0,handler:function(){Ext.getCmp("comboboxPlace").forceSelection=!1;Ext.data.StoreManager.lookup("storePlace").add(selectedFeature.attributes);
Ext.getCmp("comboboxPlace").setValue(selectedFeature.attributes.id);I=!1;Ext.getCmp("comboboxPlace").setRawValue(selectedFeature.attributes.NAME);Ext.getCmp("gridFormForm").getForm().isValid();Ext.getCmp("locationwindow").hide()}}]}]})}function Na(a){return a=Ext.create("widget.window",{id:"endNotewindow",itemId:"endNotewindow",title:"Upload EndNote XML",closable:!0,closeAction:"hide",draggable:!0,modal:!1,hideMode:"offsets",width:400,height:200,resizable:!1,listeners:{},items:[W,{id:"infoEndNote",
frame:!0,html:""}]})}function Aa(a,b){a.store.clearFilter(!0);a.store.filter({property:"L2_ID",value:b[0].data.L2_ID,exactMatch:!0});a.setValue(null);0<Ext.getCmp("comboboxLevel3").store.data.items.length?(Ext.getCmp("comboboxLevel3").enable(!0),Ext.getCmp("comboboxLevel3").setVisible(!0),Ext.getCmp("buttonAddLevel").disable(!0)):(Ext.getCmp("comboboxLevel3").setVisible(!1),Ext.getCmp("comboboxLevel3").disable(!0),Ext.getCmp("buttonAddLevel").btnInnerEl.setStyle({color:"red"}),0<Ext.getCmp("grid").getSelectionModel().selected.length&&
(v=!0,Ext.getCmp("buttonAddLevel").enable(!0)))}Ext.direct.Manager.addProvider(Ext.app.REMOTING_API);var Oa=Ext.getBody(),Z=!0,Ba,Ca=!1,ca={},p={},D=!1,o=!1,C=!1,v=!1,x="",ka="update",la="update",y=!0,E=!0,Q=!1,P=!1,O=!1,I=!1,X,s,B,N,S="PHOTO",e,Da,ma=[".gif",".jpg",".png"],m,xa,l,k,q,V=new OpenLayers.Format.GeoJSON({internalProjection:new OpenLayers.Projection("EPSG:900913"),externalProjection:new OpenLayers.Projection("EPSG:4326")}),H,ba,L,T,f,U,M,ja=!1,z=0,F=0,A=0,G=0,ia="Au7OUsIHM13kOS-CYjc5_-0jpXdt5TYxn7XEMCZZyXE9SiW5JIkgBD70bXHHFmN5",
ya,za,da=/[0-9]/;Ext.apply(Ext.form.field.VTypes,{numero:function(a,b){if(b.endPageField)return da.test(a)&&!isNaN(parseInt(Ext.getCmp(b.endPageField).getValue()))?parseInt(a)<=parseInt(Ext.getCmp(b.endPageField).getValue())?!0:!1:da.test(a);if(b.startPageField)return da.test(a)&&!isNaN(parseInt(Ext.getCmp(b.startPageField).getValue()))?parseInt(a)>=parseInt(Ext.getCmp(b.startPageField).getValue())?!0:!1:da.test(a)},numeroText:"Remember start_page <= end_page",numeroMask:/[0-9]/});var Pa=/^[1-2]\d{3}$/;
Ext.apply(Ext.form.field.VTypes,{anno:function(a){return Pa.test(a)},annoText:"Must contain a valid year (4 digits) "});var ea=/^[+-]?(1[0-7][0-9]|[1-9]?[0-9])\.[0-9]+$/;Ext.apply(Ext.form.field.VTypes,{coordinateX:function(a,b){if(b.bottomRightX)return ea.test(a)&&!isNaN(parseFloat(Ext.getCmp(b.bottomRightX).getValue()))?parseFloat(a)<parseFloat(Ext.getCmp(b.bottomRightX).getValue())?!0:!1:ea.test(a);if(b.topLeftX)return ea.test(a)&&!isNaN(parseInt(Ext.getCmp(b.topLeftX).getValue()))?parseFloat(a)>
parseFloat(Ext.getCmp(b.topLeftX).getValue())?!0:!1:ea.test(a)},coordinateXText:"Must contain a valid coordinate (-180.0< x< 180.0) and top-left < bottom-right"});var fa=/^[+-]?(89|[1-8]?[0-9])\.[0-9]+$/;Ext.apply(Ext.form.field.VTypes,{coordinateY:function(a,b){if(b.bottomRightY)return fa.test(a)&&!isNaN(parseFloat(Ext.getCmp(b.bottomRightY).getValue()))?parseFloat(a)>parseFloat(Ext.getCmp(b.bottomRightY).getValue())?!0:!1:fa.test(a);if(b.topLeftY)return fa.test(a)&&!isNaN(parseInt(Ext.getCmp(b.topLeftY).getValue()))?
parseFloat(a)<parseFloat(Ext.getCmp(b.topLeftY).getValue())?!0:!1:fa.test(a)},coordinateYText:"Must contain a valid coordinate (-90.0< x <90.0) and top-left > bottom-right "});Ext.define("ARTICLE",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},"AUTHOR","TITLE","PUB_NAME",{name:"START_PAGE",type:"int"},{name:"END_PAGE",type:"int"},"VOL",{name:"YEAR",type:"int"},"YEAR2","PUBLISHER","LINK","DOI","PLACE","NCA","SOURCE","FLAG","PLACE_ID","NCA_ID","SOURCE_ID"],proxy:{type:"direct",api:{read:Ext.ss.QueryPostGISArticle.getResults,
destroy:Ext.ss.QueryPostGISArticle.destroyRecord},reader:{type:"json",root:"records",totalProperty:"total",idProperty:"id"}}});var t=Ext.create("Ext.data.Store",{model:"ARTICLE",autoLoad:{start:0,limit:100},storeId:"storeArticle",pageSize:100});Ext.define("PLACE",{extend:"Ext.data.Model",fields:["NAME","id"]});var Qa=Ext.create("Ext.data.Store",{autoLoad:!1,model:"PLACE",storeId:"storePlace",proxy:{type:"direct",directFn:Ext.ss.QueryPostGISArticle.getPlace}});Ext.define("NCA",{extend:"Ext.data.Model",
fields:["NAME","NCA_ID"]});var Ra=Ext.create("Ext.data.Store",{autoLoad:!1,model:"NCA",storeId:"storeNCA",proxy:{type:"direct",directFn:Ext.ss.QueryPostGISArticle.getNCA}});Ext.define("SOURCE",{extend:"Ext.data.Model",fields:["NAME","SOURCE_ID"]});var Sa=Ext.create("Ext.data.Store",{autoLoad:!1,model:"SOURCE",storeId:"storeSource",proxy:{type:"direct",directFn:Ext.ss.QueryPostGISArticle.getSource}});Ext.define("LEVEL",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"L1_ID",type:"int"},
{name:"L2_ID",type:"int"},{name:"L3_ID",type:"int"},{name:"ART_ID",type:"int"},"l1name","l2name","l3name"],proxy:{type:"direct",api:{read:Ext.ss.QueryPostGISArticle.getResultsLevel,destroy:Ext.ss.QueryPostGISArticle.destroyRecordLevel}}});var Ea=Ext.create("Ext.data.Store",{model:"LEVEL",autoLoad:!1,storeId:"storeLevel"});Ext.define("LEVEL1LIST",{extend:"Ext.data.Model",fields:[{name:"L1_ID",type:"int"},"NAME"],proxy:{type:"direct",directFn:Ext.ss.QueryPostGISArticle.getListLevel1}});var Ta=Ext.create("Ext.data.Store",
{model:"LEVEL1LIST",autoLoad:!1,storeId:"storeLevel1List"});Ext.define("LEVEL2LIST",{extend:"Ext.data.Model",fields:[{name:"L2_ID",type:"int"},"NAME",{name:"L1_ID",type:"int"}],proxy:{type:"direct",directFn:Ext.ss.QueryPostGISArticle.getListLevel2}});var Ua=Ext.create("Ext.data.Store",{model:"LEVEL2LIST",autoLoad:!1,storeId:"storeLevel2List"});Ext.define("LEVEL3LIST",{extend:"Ext.data.Model",fields:[{name:"L3_ID",type:"int"},"NAME",{name:"L2_ID",type:"int"}],proxy:{type:"direct",directFn:Ext.ss.QueryPostGISArticle.getListLevel3}});
var Va=Ext.create("Ext.data.Store",{model:"LEVEL3LIST",autoLoad:!1,storeId:"storeLevel3List"});Ext.define("BBOX",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"ART_ID",type:"int"},"TLX","BRX","BRY","TLY"],proxy:{type:"direct",api:{read:Ext.ss.QueryPostGISArticle.loadFormLocation,destroy:Ext.ss.QueryPostGISArticle.destroyRecordLocation}}});var Fa=Ext.create("Ext.data.Store",{model:"BBOX",autoLoad:!1,storeId:"storeBbox"});imageViewModel=Ext.define("imageViewModel",{extend:"Ext.data.Model",
fields:[{name:"name"},{name:"url"},{name:"size",type:"float"},{name:"lastmod"},"thumb_url"]});var ra=Ext.create("Ext.data.Store",{model:"imageViewModel",proxy:{type:"ajax",url:"get-images2.php",reader:{type:"json",root:"images"},listeners:{exception:function(a,b){b.responseText?Ext.getCmp("dataImageView").update(Ext.JSON.decode(b.responseText).msg):Ext.getCmp("dataImageView").update("the server is not answering")}}}}),Wa=new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="{name}">','<div class="thumb"><img src="{thumb_url}" title="{name}"></div>',
'<span class="x-editable">{shortName}</span></div>',"</tpl>",'<div class="x-clear"></div>'),Ga=new Ext.XTemplate('<div class="details">','<tpl for=".">','<img src="{thumb_url}"><div class="details-info">',"<b>Image Name:</b>","<span>{name}</span>","<b>Size:</b>","<span>{sizeString}</span>","<b>Last Modified:</b>","<span>{lastmod}</span>",'<span><a href="{url}" target="_blank">view original</a></span></div>',"</tpl>","</div>"),Xa=Ext.create("Ext.Button",{iconCls:"add",text:"Add",handler:function(){D||
o||C||v?Ext.Msg.show({title:"Update pending",msg:"It looks like there are pending updates:<br/>"+va()+" Proceed anyway?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(a){"yes"===a&&d()}}):d()}}),Ya=Ext.create("Ext.Button",{iconCls:"delete",text:"Delete",id:"buttonDelete",itemId:"buttonDelete",disabled:!0,handler:function(){var a=Ext.getCmp("grid").getSelectionModel();g(a)}}),Za=Ext.create("Ext.Button",{iconCls:"refresh",text:"Refresh connection",handler:function(){D||o||C||v?Ext.Msg.show({title:"Update pending",
msg:"It looks like there are pending updates.<br/>"+va()+" Proceed anyway?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(a){"yes"===a&&(d(),t.load({params:{start:0,limit:100}}))}}):(d(),t.load({params:{start:0,limit:100}}))}}),$a=Ext.create("Ext.Button",{iconCls:"endNote",text:"EndNote",handler:function(){N||(N=Na(N));N.isVisible()?N.hide(this,function(){Ext.getCmp("infoEndNote").update("")}):N.show(this,function(){})}}),na=Ext.create("Ext.grid.Panel",{itemId:"grid",id:"grid",autoScroll:!0,
height:320,store:t,listeners:{select:function(a){Ext.getCmp("buttonDelete").enable();Ba=a.getSelection()[0].data;Ext.getCmp("buttonForm").setText("Update record");Ext.getCmp("buttonForm").disable();Ext.getCmp("buttonFormMap").disable();Z=!1;E=y=!0;Ext.getCmp("comboboxPlace").forceSelection=!1;Ext.getCmp("comboboxNCA").forceSelection=!1;Ext.getCmp("comboboxSource").forceSelection=!1},selectionchange:function(a,b){v=C=o=D=!1;if(b[0]){C=!1;Ext.getCmp("gridFormForm").getForm().loadRecord(b[0]);var c=
b[0].data;null==Ext.data.StoreManager.lookup("storePlace").findRecord("id",c.PLACE_ID)&&Ext.data.StoreManager.lookup("storePlace").add({NAME:c.PLACE,id:c.PLACE_ID});Ext.getCmp("comboboxPlace").setRawValue(c.PLACE);Ext.getCmp("comboboxPlace").setValue(c.PLACE_ID);null==Ext.data.StoreManager.lookup("storeNCA").findRecord("NCA_ID",c.NCA_ID)&&Ext.data.StoreManager.lookup("storeNCA").add({NAME:c.NCA,NCA_ID:c.NCA_ID});Ext.getCmp("comboboxNCA").setRawValue(c.NCA);Ext.getCmp("comboboxNCA").setValue(c.NCA_ID);
null==Ext.data.StoreManager.lookup("storeSource").findRecord("SOURCE_ID",c.SOURCE_ID)&&Ext.data.StoreManager.lookup("storeSource").add({NAME:c.SOURCE,SOURCE_ID:c.SOURCE_ID});Ext.getCmp("comboboxSource").setRawValue(c.SOURCE);Ext.getCmp("comboboxSource").setValue(c.SOURCE_ID);Ext.getCmp("gridFormForm").getForm().isValid();rec=b[0];e=b[0].data.id;Ext.getCmp("formLevel").getForm().reset();aa(e);Ext.getCmp("formAbstract").getForm().reset();sa(e);Ext.getCmp("formLocation").getForm().reset();$(e);Ext.getCmp("buttonPhotosManagement").enable();
Ext.getCmp("buttonPhotosManagement").setText("Open photos management for ART_ID="+e);Ext.getCmp("buttonMapsManagement").enable();Ext.getCmp("buttonMapsManagement").setText("Open maps management for ART_ID="+e);Ext.getCmp("boundingBoxFieldSet").setTitle("Bounding box for ART_ID="+e);Ext.getCmp("buttonFormPositionMap").disable();Ext.getCmp("buttonFormPosition").disable();Ext.getCmp("buttonDeleteBbox").disable();Ext.getCmp("buttonAddBbox").enable();Ext.getCmp("buttonRefreshBbox").enable();Ext.getCmp("buttonFormPosition").btnInnerEl&&
Ext.getCmp("buttonFormPosition").btnInnerEl.setStyle({color:"black"});Ext.getCmp("abstractAreaField").labelEl.update("Abstract for ART_ID="+e);Ext.getCmp("buttonFormAbstract").enable();Ext.getCmp("buttonAddLevel").btnInnerEl&&Ext.getCmp("buttonAddLevel").btnInnerEl.setStyle({color:"black"});Ext.getCmp("buttonDeleteLevel").disable();E=y=!0;I=O=P=Q=!1;X&&(na.getView().focusRow(X),X=null)}else Ext.getCmp("buttonPhotosManagement").disable(),Ext.getCmp("buttonPhotosManagement").setText("Please select a record to manage the photos"),
Ext.getCmp("buttonMapsManagement").disable(),Ext.getCmp("buttonMapsManagement").setText("Please select a record to manage the maps"),Ext.getCmp("boundingBoxFieldSet").setTitle("Bounding box"),Ext.getCmp("buttonFormPositionMap").disable(),Ext.getCmp("buttonFormPosition").disable(),Ext.getCmp("buttonFormPosition").btnInnerEl&&Ext.getCmp("buttonFormPosition").btnInnerEl.setStyle({color:"black"}),Ext.getCmp("abstractAreaField").labelEl.update("Abstract"),Ext.getCmp("buttonFormAbstract").disable(),Ext.getCmp("buttonForm").disable(),
Ext.getCmp("buttonFormMap").disable(),Ext.getCmp("buttonAddLevel").disable(),Ext.getCmp("buttonDeleteLevel").disable(),Ext.getCmp("buttonRefreshLevel").disable(),Ext.getCmp("buttonAddBbox").disable(),Ext.getCmp("buttonRefreshBbox").disable(),Ext.getCmp("buttonDeleteBbox").disable(),Ext.getCmp("formLocation").getForm().reset(),E=y=!0,I=O=P=Q=!1}},columns:[{dataIndex:"id",text:"ID"},{dataIndex:"AUTHOR",text:"AUTHOR",allowBlank:!1},{dataIndex:"YEAR",text:"YEAR",allowBlank:!0},{dataIndex:"TITLE",text:"TITLE",
allowBlank:!1},{dataIndex:"PUB_NAME",text:"PUBLICATION",allowBlank:!0},{dataIndex:"PUBLISHER",text:"PUBLISHER",allowBlank:!0},{dataIndex:"START_PAGE",text:"START_PAGE",allowBlank:!0},{dataIndex:"END_PAGE",text:"END_PAGE",allowBlank:!0},{dataIndex:"VOL",text:"VOLUME",allowBlank:!0},{dataIndex:"YEAR2",text:"YEAR2",allowBlank:!0},{dataIndex:"LINK",text:"LINK",allowBlank:!0},{dataIndex:"DOI",text:"DOI",allowBlank:!0},{dataIndex:"PLACE",text:"PLACE"},{dataIndex:"NCA",text:"NCA"},{dataIndex:"SOURCE",text:"SOURCE"},
{dataIndex:"FLAG",text:"FLAG"}],dockedItems:[{xtype:"toolbar",dock:"top",items:[Xa,Ya,$a,Za]},{xtype:"pagingtoolbar",id:"gridPaging",dock:"bottom",store:t,listeners:{afterrender:function(){Ext.getCmp("gridPaging").getComponent("refresh").hide()},beforechange:function(){Ext.getCmp("gridLevel").getStore().removeAll();Ext.getCmp("gridBbox").getStore().removeAll();Ext.getCmp("gridFormForm").getForm().reset();Ext.getCmp("buttonDelete").disable()}}}]});na.getView().addListener("refresh",function(){X&&Ext.getCmp("grid").getSelectionModel().select(X)});
var oa=Ext.create("Ext.Button",{id:"buttonDeleteLevel",iconCls:"delete",text:"Delete",disabled:!0,handler:function(){Ext.Msg.show({title:"Delete record",msg:"You are deleting a record permanently, this cannot be undone. Proceed?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(a){"yes"===a&&(a=Ext.getCmp("gridLevel").getSelectionModel(),Ea.proxy.api.destroy(a.getSelection()[0].data),Ext.getCmp("buttonAddLevel").btnInnerEl.setStyle({color:"black"}),v=!1,oa.disable(),Ext.getCmp("formLevel").getForm().reset(),
aa(e))}})}}),ab=Ext.create("Ext.Button",{id:"buttonRefreshLevel",iconCls:"refresh",text:"Refresh connection",disabled:!0,handler:function(){oa.disable();Ext.getCmp("buttonAddLevel").btnInnerEl.setStyle({color:"black"});v=!1;Ext.getCmp("formLevel").getForm().reset();aa(e)}}),bb=Ext.create("Ext.grid.Panel",{enableColumnResize:!1,itemId:"gridLevel",id:"gridLevel",autoScroll:!0,store:Ea,listeners:{afterlayout:function(){Ext.getCmp("gridLevel").setWidth(Ext.getCmp("panelLevelGrid").getWidth()-5)},select:function(){Ext.getCmp("buttonDeleteLevel").enable()}},
columns:[{dataIndex:"l1name",flex:1,text:"Level1"},{dataIndex:"l2name",flex:1,text:"Level2"},{dataIndex:"l3name",flex:1,text:"Level3"}],dockedItems:[{xtype:"toolbar",dock:"top",items:[oa,ab]}]}),cb=Ext.create("Ext.form.Panel",{frame:!0,id:"formLevel",itemId:"formLevel",region:"center",layout:"fit",api:{submit:Ext.ss.QueryPostGISArticle.updateFormLevel},fieldDefaults:{},items:[{xtype:"fieldset",id:"LevelFieldSet",title:"Level selection",margin:"1 1 1 1",defaultType:"textfield",defaults:{width:250,
labelAlign:"left",labelWidth:50,msgTarget:"side"},items:[{xtype:"combobox",fieldLabel:"Level1",name:"L1_ID",id:"comboboxLevel1",itemId:"comboboxLevel1",emptyText:"select...",editable:!1,typeAhead:!0,typeAheadDelay:250,queryMode:"remote",store:Ta,displayField:"NAME",valueField:"L1_ID",triggerAction:"all",selectOnTab:!0,lazyRender:!0,listClass:"x-combo-list-small",listeners:{select:function(a,b){var c=Ext.getCmp("comboboxLevel2");c.store.clearFilter(!0);c.store.filter({property:"L1_ID",value:b[0].data.L1_ID,
exactMatch:!0});c.setValue(null);Ext.getCmp("buttonAddLevel").btnInnerEl.setStyle({color:"black"});Ext.getCmp("buttonAddLevel").disable(!0);Ext.getCmp("comboboxLevel2").setVisible(!0);Ext.getCmp("comboboxLevel3").setVisible(!1)}}},{xtype:"combobox",fieldLabel:"Level2",name:"L2_ID",id:"comboboxLevel2",itemId:"comboboxLevel2",hideMode:"visibility",emptyText:"select....",editable:!1,typeAhead:!0,typeAheadDelay:250,queryMode:"remote",store:Ua,displayField:"NAME",valueField:"L2_ID",triggerAction:"all",
selectOnTab:!0,lazyRender:!0,listClass:"x-combo-list-small",enableKeyEvents:!0,listeners:{select:function(a,b){var c=Ext.getCmp("comboboxLevel3");Ca?Aa(c,b):c.store.load(function(a,n,d){d&&(Ca=!0,Aa(c,b))})}}},{xtype:"combobox",fieldLabel:"Level3",name:"L3_ID",id:"comboboxLevel3",itemId:"comboboxLevel3",hideMode:"visibility",emptyText:"select....",editable:!1,typeAhead:!0,typeAheadDelay:250,queryMode:"remote",store:Va,displayField:"NAME",valueField:"L3_ID",triggerAction:"all",selectOnTab:!0,lazyRender:!0,
listClass:"x-combo-list-small",enableKeyEvents:!0,listeners:{select:function(){0<Ext.getCmp("grid").getSelectionModel().selected.length&&(v=!0,Ext.getCmp("buttonAddLevel").enable(!0));Ext.getCmp("buttonAddLevel").btnInnerEl.setStyle({color:"red"})}}}]}],buttons:[{text:"Add",iconCls:"add",itemId:"buttonAddLevel",id:"buttonAddLevel",disabled:!0,handler:function(){var a=Ext.getCmp("formLevel").getForm();a.isValid()&&0<Ext.getCmp("grid").getSelectionModel().selected.length&&a.submit({params:{idArticle:e},
success:Ha,failure:Ha})}}]});Ext.getCmp("comboboxLevel2").setVisible(!1);Ext.getCmp("comboboxLevel3").setVisible(!1);var ga=Ext.create("Ext.Button",{id:"buttonDeleteBbox",iconCls:"delete",text:"Delete",disabled:!0,handler:function(){Ext.Msg.show({title:"Delete record",msg:"You are deleting a record permanently, this cannot be undone. Proceed?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(a){"yes"===a&&(a=Ext.getCmp("gridBbox").getSelectionModel(),Fa.proxy.api.destroy(a.getSelection()[0].data),
Ext.getCmp("buttonAddBbox").btnInnerEl.setStyle({color:"black"}),o=!1,ga.disable(),Ext.getCmp("buttonFormPositionMap").disable(),Ext.getCmp("formLocation").getForm().reset(),$(e))}})}}),db=Ext.create("Ext.Button",{id:"buttonRefreshBbox",iconCls:"refresh",text:"Refresh connection",disabled:!0,handler:function(){ga.disable();Ext.getCmp("buttonFormPositionMap").disable();Ext.getCmp("buttonAddBbox").btnInnerEl.setStyle({color:"black"});o=!1;Ext.getCmp("formLocation").getForm().reset();$(e)}}),eb=Ext.create("Ext.Button",
{id:"buttonAddBbox",iconCls:"add",text:"Add",disabled:!0,handler:function(){ga.disable();Ext.getCmp("buttonFormPositionMap").enable();Ext.getCmp("gridBbox").getView().getSelectionModel().deselectAll();Ext.getCmp("buttonAddBbox").btnInnerEl.setStyle({color:"black"});o=!1;Ext.getCmp("formLocation").getForm().reset();for(var a in p)p[a]=""}}),fb=Ext.create("Ext.grid.Panel",{enableColumnResize:!1,itemId:"gridBbox",id:"gridBbox",autoScroll:!0,store:Fa,listeners:{afterlayout:function(){},select:function(a,
b){Ext.getCmp("buttonDeleteBbox").enable();Da=b.data.id;p.TLX=b.data.TLX;p.BRX=b.data.BRX;p.BRY=b.data.BRY;p.TLY=b.data.TLY;Ext.getCmp("buttonFormPositionMap").enable();Ext.getCmp("buttonFormPosition").btnInnerEl&&Ext.getCmp("buttonFormPosition").btnInnerEl.setStyle({color:"black"});o=!1;Ext.getCmp("formLocation").getForm().loadRecord(b)}},columns:[{dataIndex:"id",flex:1,text:"ID"}],dockedItems:[{xtype:"toolbar",dock:"top",items:[eb,ga,db]}]}),gb=Ext.create("Ext.panel.Panel",{id:"middlePanel",itemId:"middlePanel",
height:330,border:0,layout:{type:"hbox",align:"stretch"},items:[{xtype:"form",frame:!0,id:"formAbstract",itemId:"formAbstract",flex:1,api:{load:Ext.ss.QueryPostGISArticle.loadFormAbstract,submit:Ext.ss.QueryPostGISArticle.updateFormAbstract},paramOrder:["id"],fieldDefaults:{labelAlign:"top",msgTarget:"side"},items:[{xtype:"textareafield",name:"TEXT",id:"abstractAreaField",itemId:"abstractAreaField",fieldLabel:"Abstract",allowBlank:!1,height:250,anchor:"100%",enableKeyEvents:!0,listeners:{change:function(){E||
(Ext.getCmp("buttonFormAbstract").enable(),Ext.getCmp("buttonFormAbstract").btnInnerEl.setStyle({color:"red"}),D=!0)},keydown:function(){E&&(E=!1)}}}],buttons:[{text:"Update",itemId:"buttonFormAbstract",id:"buttonFormAbstract",disabled:!0,handler:function(){var a=Ext.getCmp("formAbstract").getForm(),b=!0,c={};Ext.iterate(a.getValues(),function(a,b){c[a]=b},this);objectsAreSame(ca,c)&&(b=!1);la="update";isEmptyText(ca)&&(la="create");a.isValid()&&b&&a.submit({params:{id:e,kind:la},success:Ia,failure:Ia})}}]},
{xtype:"tabpanel",id:"middleRightTabPanel",itemId:"middleRightTabPanel",activeTab:0,flex:1,items:[{title:"Levels",id:"levelTab",itemId:"levelTab",layout:"border",listeners:{beforehide:function(){},beforeshow:function(){},click:function(){}},hideMode:Ext.isIE?"offsets":"display",items:[{region:"north",id:"panelLevelGrid",border:0,height:150,layout:"fit",items:[bb]},cb]},{title:"Images",layout:"accordion",id:"middleRightAccordion",itemId:"middleRightAccordion",items:[{title:"Photos",id:"panelPhotoManagement",
layout:"fit",items:[{xtype:"button",text:"Please select a record to manage the photos",itemId:"buttonPhotosManagement",id:"buttonPhotosManagement",disabled:!0,handler:function(){B||qa();B.isVisible()?B.hide(this,function(){}):(S="PHOTO",Ext.getCmp("imageWindow").setTitle("Manage photos for ART_ID="+e),B.show(this,function(){}))}}]},{title:"Maps",id:"panelMapsManagement",layout:"fit",items:[{xtype:"button",text:"Please select a record to manage the maps",itemId:"buttonMapsManagement",id:"buttonMapsManagement",
disabled:!0,handler:function(){B||qa();B.isVisible()?B.hide(this,function(){}):(S="MAP",Ext.getCmp("imageWindow").setTitle("Manage maps for ART_ID="+e),B.show(this,function(){}))}}]}]},{title:"Spatial",layout:{type:"vbox",align:"stretch"},id:"spatialTabPanel",itemId:"spatialTabPanel",hideMode:Ext.isIE?"offsets":"display",items:[{xtype:"panel",flex:0.45,layout:"fit",items:[fb]},{xtype:"form",flex:0.55,frame:!0,id:"formLocation",itemId:"formLocation",api:{submit:Ext.ss.QueryPostGISArticle.updateFormLocation},
paramOrder:["id"],items:[{xtype:"fieldset",id:"boundingBoxFieldSet",title:"Bounding box",margin:"0 0 0 10",defaultType:"textfield",defaults:{width:240,labelWidth:130},items:[{name:"TLX",fieldLabel:"Top-left long (X)",id:"TLX",itemId:"TLX",readOnly:!0},{name:"TLY",id:"TLY",itemId:"TLY",fieldLabel:"Top-left lat (Y)",readOnly:!0},{name:"BRX",id:"BRX",itemId:"BRX",fieldLabel:"Bottom-right long (X)",readOnly:!0},{name:"BRY",id:"BRY",itemId:"BRY",fieldLabel:"Bottom-right lat (Y)",readOnly:!0}]}],buttons:[{text:"Update",
itemId:"buttonFormPosition",id:"buttonFormPosition",disabled:!0,handler:function(){var a=Ext.getCmp("formLocation").getForm(),b=!0,c={};Ext.iterate(a.getValues(),function(a,b){c[a]=b},this);objectsAreSame(p,c)&&(b=!1);ka="update";if(isEmptyText(p)||isEmpty(p))ka="create";a.isValid()&&b?a.submit({params:{id:e,locid:Da,kind:ka},success:Ja,failure:Ja}):b||(Ext.getCmp("buttonFormPosition").btnInnerEl.setStyle({color:"black"}),Ext.getCmp("buttonFormPosition").disable(),o=!1)}},{text:"Map",itemId:"buttonFormPositionMap",
id:"buttonFormPositionMap",disabled:!0,handler:function(){s||(s=wa(s));s.isVisible()?s.hide(this,function(){}):(Ext.getCmp("buttonLocationPan").setVisible(!0),Ext.getCmp("buttonLocationDraw").setVisible(!0),Ext.getCmp("buttonLocationClear").setVisible(!0),Ext.getCmp("buttonLocationUpdate").setVisible(!0),Ext.getCmp("buttonPlaceUpdate").setVisible(!1),Ext.getCmp("fieldsetBoundingBox").enable(),s.show(this,function(){}))}}]}]}]}]}),hb=Ext.create("Ext.panel.Panel",{id:"mainPanel",itemId:"mainPanel",
columnWidth:0.6,height:650,layout:{type:"vbox",align:"stretch"},items:[na,gb]}),ib=Ext.create("Ext.form.Panel",{id:"form",itemId:"form",frame:!0,bodyPadding:5,flex:1,layout:"column",fieldDefaults:{labelAlign:"left",msgTarget:"side"},items:[hb,{xtype:"form",id:"gridFormForm",itemId:"gridFormForm",frame:!0,columnWidth:0.4,margin:"0 0 0 10",layout:"fit",api:{submit:Ext.ss.QueryPostGISArticle.updateFormRecord},items:[{xtype:"fieldset",id:"detailsFieldSet",itemId:"detailsFieldSet",title:"Record details",
defaults:{width:300,labelWidth:90,enableKeyEvents:!0,listeners:{change:function(){if(!y||Q)Ext.getCmp("buttonForm").enable(),Ext.getCmp("buttonForm").btnInnerEl.setStyle({color:"red"}),C=!0},keydown:function(a){switch(a.id){case "comboboxNCA":P=Ext.getCmp("comboboxNCA").forceSelection=!0;break;case "comboboxSource":O=Ext.getCmp("comboboxSource").forceSelection=!0;break;case "comboboxPlace":I=Ext.getCmp("comboboxPlace").forceSelection=!0}y&&(y=!1)},select:function(){y&&(y=!1)},expand:function(a){Q=
!0;switch(a.id){case "comboboxPlace":Ext.getCmp("buttonFormMap").enable()}}}},defaultType:"textfield",items:[{fieldLabel:"ID",name:"id",readOnly:!0,listeners:{keydown:function(){}}},{xtype:"textareafield",fieldLabel:"Authors",name:"AUTHOR",allowBlank:!1,labelStyle:"color: #f00;",enableKeyEvents:!0},{fieldLabel:"Year",name:"YEAR",vtype:"anno"},{xtype:"textareafield",fieldLabel:"Title",labelStyle:"color: #f00;",name:"TITLE",allowBlank:!1},{xtype:"textareafield",fieldLabel:"Publication",name:"PUB_NAME"},
{xtype:"textareafield",fieldLabel:"Publisher",name:"PUBLISHER"},{fieldLabel:"Start page",id:"startPg",name:"START_PAGE",vtype:"numero",endPageField:"endPg"},{fieldLabel:"End page",id:"endPg",name:"END_PAGE",vtype:"numero",startPageField:"startPg"},{fieldLabel:"Volume",name:"VOL"},{fieldLabel:"Year 2",name:"YEAR2"},{fieldLabel:"Link",name:"LINK"},{fieldLabel:"DOI",name:"DOI"},{xtype:"combobox",fieldLabel:"Place",labelStyle:"color: #f00;",name:"PLACE",id:"comboboxPlace",itemId:"comboboxPlace",allowBlank:!1,
emptyText:"select from database",typeAhead:!0,typeAheadDelay:250,queryMode:"remote",displayField:"NAME",valueField:"id",triggerAction:"all",selectOnTab:!0,store:Qa,lazyRender:!0,listClass:"x-combo-list-small",enableKeyEvents:!0},{fieldLabel:"NCA",labelStyle:"color: #f00;",name:"NCA",xtype:"combobox",id:"comboboxNCA",itemId:"comboboxNCA",allowBlank:!1,emptyText:"select from database",typeAhead:!0,typeAheadDelay:250,queryMode:"remote",displayField:"NAME",valueField:"NCA_ID",triggerAction:"all",selectOnTab:!0,
store:Ra,lazyRender:!0,listClass:"x-combo-list-small",enableKeyEvents:!0},{fieldLabel:"Source",labelStyle:"color: #f00;",name:"SOURCE",xtype:"combobox",id:"comboboxSource",itemId:"comboboxSource",allowBlank:!1,emptyText:"select from database",typeAhead:!0,typeAheadDelay:250,queryMode:"remote",displayField:"NAME",valueField:"SOURCE_ID",triggerAction:"all",selectOnTab:!0,store:Sa,lazyRender:!0,listClass:"x-combo-list-small",enableKeyEvents:!0}]}]}],buttons:[{text:"map Places",itemId:"buttonFormMap",
id:"buttonFormMap",disabled:!0,handler:function(){if(I){var a=Ext.getCmp("comboboxPlace").getPicker().store.data.items;0<a.length&&(console.log("there are "+a.length+" plsces listed"),s||(s=wa(s)),s.isVisible()?s.hide(this,function(){}):(Ext.getCmp("buttonLocationPan").setVisible(!1),Ext.getCmp("buttonLocationDraw").setVisible(!1),Ext.getCmp("buttonLocationClear").setVisible(!1),Ext.getCmp("buttonLocationUpdate").setVisible(!1),Ext.getCmp("buttonPlaceUpdate").setVisible(!0),Ext.getCmp("fieldsetBoundingBox").disable(),
s.show(this,function(){})))}else console.log("there are no places listed")}},{text:"Save new record",itemId:"buttonForm",id:"buttonForm",disabled:!0,handler:function(){var a=Ext.getCmp("gridFormForm").getForm(),b=!0;if(!Z){var c={};Ext.iterate(a.getValues(),function(a,b){c[a]=b},this);objectsAreSame(Ba,c)&&(b=!1,Ext.getCmp("buttonForm").btnInnerEl.setStyle({color:"black"}),Ext.getCmp("buttonForm").disable(),Ext.getCmp("buttonFormMap").disable())}a.isValid()&&b&&ha(Ext.getCmp("comboboxNCA"),P)&&ha(Ext.getCmp("comboboxPlace"),
I)&&ha(Ext.getCmp("comboboxSource"),O)&&a.submit({success:Ka,failure:Ka})}}]});Ext.create("Ext.panel.Panel",{id:"applicationPanel",itemId:"applicationPanel",height:750,width:1E3,border:0,layout:{type:"vbox",align:"stretch"},items:[{xtype:"tabpanel",id:"applicationTab",itemId:"applicationTab",activeTab:0,flex:1,items:[{title:"Bibliographic records",items:[ib]},{title:"INSPIRE",id:"inspireTab",itemId:"inspireTab"}]}],renderTo:Oa});var pa=new Ext.Toolbar({style:"border:1px solid #99BBE8;"});pa.add("->",
{text:"Delete",id:"deleteImageViewButton",icon:"img/delete.png",disabled:!0,handler:function(){Ext.Msg.show({title:"Delete record",msg:"You are deleting a record permanently, this cannot be undone. Proceed?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(a){if("yes"===a&&(a=Ext.getCmp("dataImageView").getSelectionModel().selected,0!=a.length)){for(var b="",c=0;c<a.length;c++)b=b+a.items[c].data.name+";";Ext.Ajax.request({url:"delete.php",method:"post",params:{images:b,id:e,table:S},success:function(a){a=
Ext.JSON.decode(a.responseText);a.success?""!=a.msg?Ext.Msg.show({title:"Warning",msg:a.msg,buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.WARNING,fn:function(a){"yes"==a&&r()}}):r():Ext.Msg.show({title:"Error",msg:"Deleting images failed<br/>"+a.msg,buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.ERROR,fn:function(a){"yes"==a&&r()}})},failure:function(a){var b="the connection is unaivailable";a.responseText&&(b=Ext.JSON.decode(a.responseText).msg);Ext.Msg.show({title:"Error",msg:"Deleting images failed<br/>"+
b,buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.ERROR,fn:function(a){a=="yes"&&r()}})}})}}})}});pa.add({text:"Refresh",id:"refreshImageViewButton",icon:"img/refresh.png",handler:function(){r()}});var jb=Ext.create("Ext.view.View",{id:"dataImageView",autoScroll:!0,store:ra,tpl:Wa,multiSelect:!0,autoHeight:!1,height:450,trackOver:!0,style:"border:1px solid #99BBE8; border-top-width: 0",overItemCls:"x-item-over",itemSelector:"div.thumb-wrap",emptyText:"No images to display",prepareData:function(a){Ext.apply(a,
{shortName:Ext.util.Format.ellipsis(a.name,15),sizeString:Ext.util.Format.fileSize(a.size)});return a},listeners:{selectionchange:function(a,b){var c=b.length,h=1!==c?"s":"";Ext.getCmp("images-view").setTitle("Image management ("+c+" item"+h+" selected)");0===c?(Ext.getCmp("panelImageViewRightBottom").update(""),Ext.getCmp("deleteImageViewButton").disable()):(Ga.overwrite(La.body,b[0].data),Ext.getCmp("deleteImageViewButton").enable())},itemclick:function(){}}}),kb=Ext.create("Ext.Panel",{id:"images-view",
frame:!0,flex:2,layout:"auto",title:"Image management",items:[pa,jb]}),Y=Ext.create("Ext.form.Panel",{id:"panelImageViewRightTop",title:"Upload Images",flex:1,buttonAlign:"center",fileUpload:!0,items:[{xtype:"fileuploadfield",emptyText:"",fieldLabel:"Image 1",labelWidth:50,buttonText:"Select a File",width:240,name:"img[]"},{xtype:"fileuploadfield",emptyText:"",fieldLabel:"Image 2",labelWidth:50,buttonText:"Select a File",width:240,name:"img[]"},{xtype:"fileuploadfield",emptyText:"",fieldLabel:"Image 3",
labelWidth:50,buttonText:"Select a File",width:240,name:"img[]"},{xtype:"fileuploadfield",emptyText:"",fieldLabel:"Image 4",labelWidth:50,buttonText:"Select a File",width:240,name:"img[]"},{xtype:"fileuploadfield",emptyText:"",fieldLabel:"Image 5",labelWidth:50,buttonText:"Select a File",width:240,name:"img[]"}],buttons:[{text:"Upload",handler:function(){Y.getForm().submit({params:{id:e,table:S},url:"upload.php",waitMsg:"Uploading ....",success:function(a,b){Y.getForm().reset();var c=Ext.JSON.decode(b.response.responseText);
"0"==c.failed&&"0"!=c.uploaded?Ext.Msg.show({title:"Success",msg:"All files uploaded<br/> "+c.msg,buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.INFO,fn:function(a){"yes"==a&&r()}}):"0"==c.uploaded?Ext.Msg.show({title:"Warning",msg:"Nothing Uploaded, is the single and total file size correct? (each image 10MB=10485760 bites, total 50 MB = 52 428 800 bites)",buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.WARNING,fn:function(a){"yes"==a&&r()}}):Ext.Msg.show({title:"Success",msg:c.uploaded+" files uploaded <br/>"+
c.failed+" files failed to upload",buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.INFO,fn:function(a){"yes"==a&&r()}})},failure:function(a,b){switch(b.failureType){case Ext.form.action.Action.CONNECT_FAILURE:Ext.Msg.show({title:"Failure",msg:"Ajax communication failed",buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.ERROR,fn:function(a){"yes"==a&&r()}});break;case Ext.form.action.Action.SERVER_INVALID:Ext.Msg.show({title:"Failure",msg:b.result.msg+" "+b.result.msg2,buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.ERROR,
fn:function(a){"yes"==a&&r()}});break;case Ext.form.action.Action.LOAD_FAILURE:Ext.Msg.show({title:"Failure",msg:"LOAD_FAILURE",buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.ERROR,fn:function(a){"yes"==a&&r()}});break;default:Ext.Msg.show({title:"Failure",msg:"Connection aborted",buttons:Ext.Msg.YES,closable:!1,icon:Ext.Msg.ERROR})}}})}},{text:"Reset",handler:function(){Y.getForm().reset()}}]}),La=Ext.create("Ext.Panel",{title:"Image Detail",flex:1.5,id:"panelImageViewRightBottom",tpl:Ga});Y.getForm().on("beforeaction",
function(a,b){if("submit"==b.type){var c=!1,d=Ext.getCmp("panelImageViewRightTop").getForm().getFields().items,n;for(n in d)if(""!==d[n].getValue()){c=!0;break}if(c)for(n in d){if(exts=d[n].getValue().slice(d[n].getValue().indexOf(".")).toLowerCase(),""!=exts){c=!1;for(n=0;n<ma.length;n++)if(ma[n]==exts){c=!0;break}if(!c){Ext.Msg.alert("",'Please,select a .gif",.jpg",.png" file');break}}}else Ext.Msg.alert("","Please,select one file");return c}});panelImageViewRight=Ext.create("Ext.Panel",{frame:!0,
flex:1,id:"panelImageViewRight",layout:{type:"vbox",align:"stretch"},items:[Y,La]});panelImageView=Ext.create("Ext.Panel",{width:800,height:520,id:"panelImageView",layout:{type:"hbox",align:"stretch"},items:[kb,panelImageViewRight]});var Ka=function(a,b){azione=b;b.result.success?(C=!1,Z?t.loadPage(Math.ceil((t.getTotalCount()+1)/100),{params:{start:0,limit:100},callback:function(a,b,d){d&&(Ext.getCmp("buttonForm").btnInnerEl.setStyle({color:"black"}),Ext.getCmp("buttonForm").disable(),Ext.getCmp("buttonFormMap").disable())}}):
t.load({params:{start:0,limit:100},callback:function(a,b,d){d&&(Ext.getCmp("buttonForm").btnInnerEl.setStyle({color:"black"}),Ext.getCmp("buttonForm").disable(),Ext.getCmp("buttonFormMap").disable())}})):Ext.MessageBox.alert("Failure",b.result.msg)},ta=function(a,b){azione=b;b.result.success?(ca.TEXT=void 0!=b.result.data?b.result.data.TEXT:"",Ext.getCmp("buttonFormAbstract").btnInnerEl.setStyle({color:"black"}),D=!1,E=!0):(ca.TEXT="",Ext.MessageBox.alert("Failure loading the abstract",b.result.msg))},
Ia=function(a,b){b.result.success?(Ext.getCmp("buttonFormAbstract").btnInnerEl.setStyle({color:"black"}),Ext.getCmp("buttonFormAbstract").disable(),D=!1,sa(e)):Ext.MessageBox.alert("Failure updating the abstract",b.result.msg)},ua=function(a,b){if(b.result.success){for(var c in p)p[c]="";Ext.getCmp("buttonFormPosition").btnInnerEl&&Ext.getCmp("buttonFormPosition").btnInnerEl.setStyle({color:"black"});Ext.getCmp("buttonFormPositionMap").disable();o=!1}else{for(c in p)p[c]="";Ext.MessageBox.alert("Failure loading the map",
b.result.msg)}},Ja=function(a,b){b.result.success?(Ext.getCmp("buttonFormPosition").btnInnerEl.setStyle({color:"black"}),Ext.getCmp("buttonFormPosition").disable(),Ext.getCmp("buttonFormPositionMap").disable(),Ext.getCmp("buttonDeleteBbox").disable(),o=!1,Ext.getCmp("formLocation").getForm().reset(),$(e)):Ext.MessageBox.alert("Failure updating the map",b.result.msg)},Ha=function(a,b){b.result.success?(Ext.getCmp("buttonAddLevel").btnInnerEl.setStyle({color:"black"}),v=!1,aa(e)):Ext.MessageBox.alert("Failure adding new record for levels",
b.result.msg)},w=function(a,b){if(Ext.getCmp("formBoundingBox").getForm().isValid())switch(a.id){case "BRYField":R(0,3,0,b-z,0,b-z);z=b;break;case "TLYField":R(1,2,0,b-F,0,b-F);F=b;break;case "TLXField":R(1,0,b-A,0,b-A,0);A=b;break;case "BRXField":R(2,3,b-G,0,b-G,0),G=b}},W=Ext.create("Ext.form.Panel",{id:"panelEndNote",buttonAlign:"center",fileUpload:!0,items:[{xtype:"fileuploadfield",margin:"5 5 5 5",frame:!0,emptyText:"",fieldLabel:"EndNote XML",labelWidth:100,buttonText:"Select a File",width:350,
name:"xml"}],buttons:[{text:"Upload",handler:function(){W.getForm().submit({url:"endNote.php",waitMsg:"Uploading ....",success:function(a,b){W.getForm().reset();var c=Ext.JSON.decode(b.response.responseText);c.success?(Ext.getCmp("infoEndNote").update(c.msg),d(),t.loadPage(Math.ceil((t.getTotalCount()+parseFloat(c.inserted))/100),{params:{start:0,limit:100}})):Ext.getCmp("infoEndNote").update(c.msg)},failure:function(a,b){switch(b.failureType){case Ext.form.action.Action.CLIENT_INVALID:Ext.getCmp("infoEndNote").update("Form fields may not be submitted with invalid values");
break;case Ext.form.action.Action.CONNECT_FAILURE:Ext.getCmp("infoEndNote").update("Ajax communication failed");break;case Ext.form.action.Action.SERVER_INVALID:Ext.getCmp("infoEndNote").update("SERVER_INVALID");break;case Ext.form.action.Action.LOAD_FAILURE:Ext.getCmp("infoEndNote").update("LOAD_FAILURE");break;default:Ext.getCmp("infoEndNote").update("Connection aborted")}}})}},{text:"Reset",handler:function(){W.getForm().reset()}}]});W.getForm().on("beforeaction",function(a,b){if("submit"==b.type){var c=
!1,d=Ext.getCmp("panelEndNote").getForm().getFields().items,e;for(e in d)if(""!==d[e].getValue()){c=!0;break}if(c)for(e in d){if(exts=d[e].getValue().slice(d[e].getValue().indexOf(".")).toLowerCase(),""!=exts){c=!1;for(e=0;e<ma.length;e++)if(".xml"==exts){c=!0;break}if(!c){Ext.getCmp("infoEndNote").update("Please,select an .xml file");break}}}else Ext.getCmp("infoEndNote").update("Please,select one file");return c}})});
function objectsAreSame(d,g){if(isEmpty(d)||isEmpty(g))return isEmpty(d)&&isEmpty(g)?!0:!1;var J=!0,u;for(u in d)if(null==d[u]&&(d[u]=""),null==g[u]&&(g[u]=""),d[u].toString()!==g[u].toString()){J=!1;break}return J}function isEmpty(d){for(var g in d)if(d.hasOwnProperty(g))return!1;return!0}function isEmptyText(d){for(var g in d)if(""==d[g])return!0;return!1}function setOptions(d){polygonControl.handler.setOptions(d)}
function uniqueArr(d){var g=[];for(i=0;i<d.length;i++)contains(g,d[i])||g.push(d[i]);return g}function contains(d,g){for(j=0;j<d.length;j++)if(d[j]==g)return!0;return!1};